# omniFUSE CI/CD pipeline for SourceCraft.dev
# Docs: https://sourcecraft.dev/portal/docs/en/sourcecraft/operations/ci-cd

on:
  push:
    - workflows: [check, test]
      filter:
        branches: ["main"]
  pull_request:
    - workflows: [check, test]

workflows:
  check:
    tasks:
      - clippy
      - fmt

  test:
    tasks:
      - unit-tests
      - integration-tests

tasks:
  - name: clippy
    env:
      RUSTUP_PERMIT_COPY_RENAME: "1"
    cubes:
      - name: run-clippy
        image: rustlang/rust:nightly
        script:
          # exclude omnifuse-gui: Tauri needs GTK/webkit system libs not in image
          - cargo clippy --workspace --exclude omnifuse-gui -- -D warnings

  - name: fmt
    env:
      RUSTUP_PERMIT_COPY_RENAME: "1"
    cubes:
      - name: run-fmt
        image: rustlang/rust:nightly
        script:
          - cargo fmt --all -- --check

  - name: unit-tests
    env:
      RUSTUP_PERMIT_COPY_RENAME: "1"
    cubes:
      - name: run-tests
        image: rustlang/rust:nightly
        script:
          - apt-get update && apt-get install -y fuse3 libfuse3-dev
          - cargo test --workspace --exclude omnifuse-gui -- --skip fuse_mount --skip real_api

  - name: integration-tests
    env:
      RUSTUP_PERMIT_COPY_RENAME: "1"
    cubes:
      - name: run-fuse-tests
        image: rustlang/rust:nightly
        script:
          - apt-get update && apt-get install -y fuse3 libfuse3-dev
          - cargo test --workspace --exclude omnifuse-gui --test fuse_mount_tests
